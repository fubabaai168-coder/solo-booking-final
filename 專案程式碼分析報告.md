# 專案程式碼分析報告：表單提交與 Google Sheet 寫入流程

## 📋 執行摘要

**重要發現**：目前專案中**沒有找到餐廳預約表單**相關的程式碼。專案中僅存在一個「在地商家搜尋」功能，該功能包含 Google Sheets 寫入邏輯，可作為參考範例。

---

## 1️⃣ 前端表單組件

### ❌ 餐廳預約表單
- **狀態**：未找到
- **搜尋結果**：專案中沒有包含 `reservation`、`booking` 或預約相關的 React 組件

### ✅ 現有表單組件

#### `app/local/page.tsx` - 在地商家搜尋表單
- **檔案路徑**：`soloai-website/app/local/page.tsx`
- **組件名稱**：`LocalBizFinder`
- **關鍵函式**：
  - `handleSearch()` - 處理搜尋提交
- **核心邏輯**：
  - 使用 React Hooks (`useState`) 管理表單狀態
  - 包含兩個輸入欄位：`keyword`（關鍵字）和 `region`（地區）
  - 透過 `fetch` API 發送 GET 請求到 `/local/api/search`
  - 處理載入狀態和錯誤處理
- **表單欄位**：
  - `keyword` - 搜尋關鍵字（例如：咖啡）
  - `region` - 搜尋地區（預設：高雄市）
- **提交方式**：點擊按鈕觸發 `handleSearch()`，使用 GET 請求（非傳統表單 POST）

---

## 2️⃣ API 路由

### ✅ 現有 API 路由

#### `app/local/api/search/route.ts` - 在地商家搜尋 API
- **檔案路徑**：`soloai-website/app/local/api/search/route.ts`
- **HTTP 方法**：`GET`
- **端點路徑**：`/local/api/search`
- **查詢參數**：
  - `keyword` - 搜尋關鍵字
  - `region` - 搜尋地區（預設：高雄市）
- **核心功能**：
  1. 接收前端搜尋請求
  2. 呼叫 Google Places API 搜尋商家
  3. 將搜尋結果寫入 Google Sheets
  4. 返回搜尋結果給前端

---

## 3️⃣ Google Sheets 相關程式碼

### ✅ Google Sheets 寫入邏輯

**位置**：`app/local/api/search/route.ts` (第 52-95 行)

#### 關鍵函式與邏輯：

1. **身份驗證** (第 54-59 行)
   ```typescript
   const auth = new google.auth.JWT(
     process.env.GOOGLE_SERVICE_ACCOUNT_EMAIL,
     undefined,
     process.env.GOOGLE_SERVICE_ACCOUNT_KEY?.replace(/\\n/g, "\n"),
     ["https://www.googleapis.com/auth/spreadsheets"]
   );
   ```
   - 使用 JWT 認證
   - 環境變數：`GOOGLE_SERVICE_ACCOUNT_EMAIL`、`GOOGLE_SERVICE_ACCOUNT_KEY`

2. **初始化 Sheets API** (第 61 行)
   ```typescript
   const sheets = google.sheets({ version: "v4", auth });
   ```

3. **工作表管理** (第 63-79 行)
   - **工作表名稱**：動態生成 `{region}_{keyword}`
   - **工作表 ID**：從環境變數 `GOOGLE_SHEETS_ID` 讀取
   - **檢查工作表是否存在**：使用 `sheets.spreadsheets.get()`
   - **建立新工作表**：如果不存在，使用 `sheets.spreadsheets.batchUpdate()` 建立

4. **資料寫入** (第 81-94 行)
   ```typescript
   const values = results.map((r) => [
     r.name,
     r.address,
     r.rating,
     new Date().toLocaleString("zh-TW"),
   ]);
   
   await sheets.spreadsheets.values.append({
     spreadsheetId: sheetId,
     range: `${sheetName}!A:D`,
     valueInputOption: "USER_ENTERED",
     requestBody: { values },
   });
   ```
   - **寫入欄位**：名稱、地址、評分、時間戳記
   - **寫入範圍**：`{sheetName}!A:D`（A 到 D 欄）
   - **寫入方式**：`append`（追加到最後一行）

#### 使用的環境變數：
- `GOOGLE_SERVICE_ACCOUNT_EMAIL` - Google 服務帳號電子郵件
- `GOOGLE_SERVICE_ACCOUNT_KEY` - Google 服務帳號私鑰（需要處理換行符）
- `GOOGLE_SHEETS_ID` - Google Sheets 試算表 ID

#### 使用的套件：
- `googleapis` (版本：^165.0.0) - Google APIs 客戶端庫

---

## 4️⃣ 程式碼結構摘要

### 檔案樹狀結構
```
soloai-website/
├── app/
│   ├── local/
│   │   ├── page.tsx              # 前端搜尋表單組件
│   │   └── api/
│   │       └── search/
│   │           └── route.ts      # API 路由 + Google Sheets 寫入邏輯
│   ├── page.tsx                  # 首頁（僅提及預約系統，無實際表單）
│   └── layout.tsx                # 根布局（僅提及預約系統）
└── package.json                  # 依賴：googleapis@^165.0.0
```

---

## 5️⃣ 發現的問題與建議

### ⚠️ 發現的問題

1. **缺少餐廳預約表單**
   - 專案中沒有實際的餐廳預約表單組件
   - 首頁和布局檔案僅提及「預約系統」，但沒有實作

2. **API 路由僅支援 GET 請求**
   - 現有的 API 路由使用 GET 方法
   - 傳統表單提交通常使用 POST 方法

3. **Google Sheets 寫入邏輯僅在搜尋功能中**
   - 目前 Google Sheets 寫入邏輯僅用於記錄搜尋結果
   - 沒有專門處理表單提交的 API 端點

### 💡 建議

1. **建立餐廳預約表單組件**
   - 建立新的 React 組件（例如：`app/reservation/page.tsx`）
   - 包含必要的表單欄位（姓名、電話、日期、時間、人數等）

2. **建立預約提交 API 路由**
   - 建立新的 API 路由（例如：`app/api/reservation/route.ts`）
   - 使用 POST 方法處理表單提交
   - 參考現有的 Google Sheets 寫入邏輯

3. **重構 Google Sheets 寫入邏輯**
   - 可考慮將 Google Sheets 寫入邏輯抽取為共用函式
   - 方便多個 API 路由重複使用

---

## 6️⃣ 可用於修復的參考程式碼

### Google Sheets 寫入範例（來自 `app/local/api/search/route.ts`）

```typescript
// 身份驗證
const auth = new google.auth.JWT(
  process.env.GOOGLE_SERVICE_ACCOUNT_EMAIL,
  undefined,
  process.env.GOOGLE_SERVICE_ACCOUNT_KEY?.replace(/\\n/g, "\n"),
  ["https://www.googleapis.com/auth/spreadsheets"]
);

// 初始化 Sheets API
const sheets = google.sheets({ version: "v4", auth });

// 準備資料
const values = [
  ["欄位1", "欄位2", "欄位3", new Date().toLocaleString("zh-TW")]
];

// 寫入資料
await sheets.spreadsheets.values.append({
  spreadsheetId: process.env.GOOGLE_SHEETS_ID,
  range: "工作表名稱!A:D",
  valueInputOption: "USER_ENTERED",
  requestBody: { values },
});
```

---

## 📝 總結

目前專案中**沒有餐廳預約表單**的實作，但存在一個完整的 Google Sheets 寫入範例（在地商家搜尋功能）。可以參考 `app/local/api/search/route.ts` 中的 Google Sheets 寫入邏輯來建立新的預約表單提交功能。

**下一步建議**：
1. 建立餐廳預約表單前端組件
2. 建立處理預約提交的 POST API 路由
3. 參考現有的 Google Sheets 寫入邏輯實作資料寫入功能










