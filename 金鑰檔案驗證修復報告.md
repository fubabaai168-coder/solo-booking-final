# 🔧 金鑰檔案驗證修復報告

## 📋 問題分析

### 原始問題
- **錯誤訊息：** `No key or keyFile set.`
- **根本原因：** 環境變數中的私鑰字串在 Next.js webpack 打包環境中無法正確解析
- **影響範圍：** 所有使用 Google API 的預約功能

### 解決方案
切換到使用**服務帳號 JSON 檔案**進行驗證，讓 `google-auth-library` 直接讀取檔案，繞過環境變數字串解析問題。

---

## ✅ 已實施的修復

### 修復內容

**位置：** `app/api/reservation/route.ts`

**主要變更：**

1. **引入 `path` 模組**
   ```typescript
   import path from "path";
   ```

2. **移除環境變數相關程式碼**
   - 移除了所有 `GOOGLE_SERVICE_ACCOUNT_KEY` 環境變數讀取邏輯
   - 移除了私鑰字串處理和驗證邏輯

3. **使用 GoogleAuth 搭配 keyFile**
   ```typescript
   // 定義服務帳號金鑰檔案的路徑
   const KEYFILE_PATH = path.join(process.cwd(), 'localbizfinder-477001-40e17afc46ea.json.json');
   
   // 使用 GoogleAuth 搭配 keyFile
   const auth = new google.auth.GoogleAuth({
     keyFile: KEYFILE_PATH,
     scopes: [
       "https://www.googleapis.com/auth/spreadsheets",
       "https://www.googleapis.com/auth/calendar",
     ],
   });
   ```

---

## 🔍 技術細節

### GoogleAuth vs JWT

#### 方式 1：JWT（修復前）❌
```typescript
const auth = new google.auth.JWT(
  email,
  undefined,
  privateKey, // 從環境變數讀取，可能有解析問題
  scopes
);
```
- **問題：** 環境變數中的換行符可能無法正確解析
- **適用場景：** 簡單的 Node.js 環境

#### 方式 2：GoogleAuth + keyFile（修復後）✅
```typescript
const auth = new google.auth.GoogleAuth({
  keyFile: KEYFILE_PATH, // 直接讀取 JSON 檔案
  scopes: scopes
});
```
- **優點：** 
  - 繞過環境變數解析問題
  - Google 函式庫自行處理金鑰載入
  - 更可靠、更標準的做法
- **適用場景：** Next.js、webpack 打包環境

### 檔案路徑

- **檔案名稱：** `localbizfinder-477001-40e17afc46ea.json.json`
- **檔案位置：** 專案根目錄（`soloai-website/`）
- **路徑構建：** `path.join(process.cwd(), 'localbizfinder-477001-40e17afc46ea.json.json')`

---

## 🧪 測試步驟

### 步驟 1：確認檔案存在

1. **檢查檔案是否存在：**
   ```bash
   ls soloai-website/localbizfinder-477001-40e17afc46ea.json.json
   ```

2. **確認檔案格式：**
   - 檔案應該是有效的 JSON 格式
   - 包含 `private_key`、`client_email` 等欄位

### 步驟 2：重新啟動伺服器

1. **停止當前伺服器**（如果正在運行）
2. **重新啟動：**
   ```bash
   npm run dev
   ```

### 步驟 3：測試預約功能

1. 訪問：`http://localhost:3000/reservation`
2. 填寫表單並提交

### 步驟 4：檢查終端機日誌

**成功時應看到：**
```
🔐 開始 Google 身份驗證...
📁 服務帳號金鑰檔案路徑: D:\soloai-project\soloai-website\localbizfinder-477001-40e17afc46ea.json.json
✅ Google 身份驗證物件已初始化（使用金鑰檔案）
📊 初始化 Google Sheets API...
📅 初始化 Google Calendar API...
⏰ 處理日期和時間...
📅 創建 Google 日曆事件...
✅ 日曆事件創建成功: https://calendar.google.com/...
📊 寫入 Google Sheets...
✅ Google Sheets 寫入成功
✅ 預約成功完成
```

**如果失敗，檢查：**
1. 檔案路徑是否正確
2. 檔案是否存在且可讀取
3. 檔案格式是否正確（有效的 JSON）
4. 檔案權限是否正確

---

## 📝 修復摘要

| 項目 | 狀態 | 說明 |
|------|------|------|
| 環境變數解析問題 | ✅ 已繞過 | 改用檔案讀取方式 |
| JWT 初始化 | ✅ 已替換 | 改用 GoogleAuth + keyFile |
| 檔案路徑 | ✅ 已設定 | 使用 `path.join(process.cwd(), ...)` |
| 程式碼簡化 | ✅ 已完成 | 移除了複雜的字串處理邏輯 |

---

## ⚠️ 注意事項

### 安全性

1. **不要將服務帳號 JSON 檔案提交到 Git**
   - 確保 `.gitignore` 中包含 `*.json`（除了 `package.json` 等必要檔案）
   - 或明確排除服務帳號檔案：`localbizfinder-*.json.json`

2. **檔案權限**
   - 確保檔案只有應用程式可以讀取
   - 在生產環境中，考慮使用環境變數或密鑰管理服務

### 部署考量

- **本地開發：** 使用檔案方式（當前方案）
- **生產環境：** 可以考慮：
  - 繼續使用檔案方式（需要確保檔案存在於部署環境）
  - 或使用環境變數 + 正確的換行符處理
  - 或使用 Google Cloud Secret Manager

---

## 🎯 下一步

1. **重新啟動開發伺服器**
2. **測試預約功能**
3. **確認終端機日誌**顯示 `✅ Google 身份驗證物件已初始化（使用金鑰檔案）`
4. **驗證 Google Sheets 和 Calendar 寫入成功**

---

**修復完成時間：** 2025-01-15
**修復內容：** 
1. 切換到使用服務帳號 JSON 檔案驗證
2. 使用 `GoogleAuth` + `keyFile` 替代 `JWT` + 環境變數
3. 簡化程式碼，移除複雜的字串處理邏輯










