# 🔧 401 UNAUTHENTICATED 錯誤修復報告

## 📋 錯誤分析

### 錯誤訊息
```
Request is missing required authentication credential. Expected OAuth 2 access token, login cookie or other valid authentication credential.
```

### 錯誤位置
- **發生位置：** `app/api/reservation/route.ts:102:31`（實際為第 113 行的 `calendar.events.insert`）
- **錯誤代碼：** `401 UNAUTHENTICATED`
- **HTTP 狀態碼：** `401`

### 關鍵觀察

從終端機日誌中發現：

1. **環境變數狀態：** ✅ 全部已設定
   - `GOOGLE_SERVICE_ACCOUNT_EMAIL`: 已設定
   - `GOOGLE_SERVICE_ACCOUNT_KEY`: 已設定（1704 字符）
   - `GOOGLE_SHEETS_ID`: 已設定
   - `GOOGLE_CALENDAR_ID`: 已設定

2. **金鑰格式：** ✅ 正確
   - 長度：1704 字符
   - 前 50 字符：`-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w...`
   - **是否包含換行符：是** ✅
   - **是否包含 \n 字串：否** ✅

3. **問題根源：**
   - JWT 認證物件已創建，但**未在實際使用前獲取 access token**
   - Google API 需要先調用 `auth.authorize()` 來獲取 OAuth 2 access token

---

## ✅ 已實施的修復

### 修復內容

**位置：** `app/api/reservation/route.ts` 第 77-80 行

**新增程式碼：**
```typescript
// ⭐ 關鍵修正：在實際使用前，先獲取 access token
console.log("🔑 獲取 Google API access token...");
await auth.authorize();
console.log("✅ Google API 認證成功");
```

**修復說明：**
- 在初始化 Google Sheets 和 Calendar API 之前，先調用 `auth.authorize()`
- 這會向 Google 伺服器請求 OAuth 2 access token
- 只有獲取到 access token 後，才能成功調用 Google API

---

## 🔍 其他潛在問題

### 1. 日曆 ID 可能是佔位符

**觀察：**
- 日誌顯示：`日曆 ID: your-calendar-id@group.calendar.google.com`
- 這看起來像是佔位符，不是實際的日曆 ID

**檢查方法：**
1. 確認 `.env.local` 中的 `GOOGLE_CALENDAR_ID` 是否為實際值
2. 如果仍是 `your-calendar-id@group.calendar.google.com`，需要替換為實際的日曆 ID

**取得實際日曆 ID：**
1. 開啟 Google Calendar
2. 點擊「設定」→「我的日曆」
3. 找到要使用的日曆，點擊「整合日曆」
4. 複製「日曆 ID」（通常是 Email 格式）

### 2. 服務帳號權限

**確認項目：**
- ✅ 服務帳號 Email：`places-api-service@localbizfinder-477001.iam.gserviceaccount.com`
- ⚠️ 需要確認該服務帳號是否有權限：
  - 存取 Google Sheets（試算表）
  - 在 Google Calendar 中創建活動

---

## 🧪 測試步驟

### 步驟 1：確認修復已應用

1. **重新啟動開發伺服器**（如果正在運行）
2. **確認程式碼已更新**

### 步驟 2：提交測試預約單

1. 訪問：`http://localhost:3000/reservation`
2. 填寫表單並提交

### 步驟 3：檢查終端機日誌

**成功時應看到：**
```
🔐 開始 Google 身份驗證...
📋 環境變數讀取檢查:
  ...
🔑 獲取 Google API access token...
✅ Google API 認證成功
📊 初始化 Google Sheets API...
📅 初始化 Google Calendar API...
⏰ 處理日期和時間...
📅 創建 Google 日曆事件...
✅ 日曆事件創建成功: https://calendar.google.com/...
📊 寫入 Google Sheets...
✅ Google Sheets 寫入成功
✅ 預約成功完成
```

**如果仍然失敗，檢查：**
1. 是否看到 `✅ Google API 認證成功` 訊息
2. 如果沒有，檢查錯誤訊息
3. 確認日曆 ID 是否為實際值（不是佔位符）

---

## 📝 修復摘要

| 項目 | 狀態 | 說明 |
|------|------|------|
| 環境變數設定 | ✅ 已確認 | 所有環境變數都已設定 |
| 金鑰格式 | ✅ 正確 | 已包含實際換行符 |
| JWT 認證初始化 | ✅ 已修復 | 新增 `await auth.authorize()` |
| 日曆 ID | ⚠️ 需確認 | 可能是佔位符 |
| 服務帳號權限 | ⚠️ 需確認 | 需要確認權限設定 |

---

## 🎯 下一步

1. **重新啟動開發伺服器**
2. **測試預約功能**
3. **檢查終端機日誌**，確認是否看到 `✅ Google API 認證成功`
4. **如果仍然失敗：**
   - 確認日曆 ID 是否為實際值
   - 確認服務帳號權限
   - 檢查完整的錯誤日誌

---

**修復完成時間：** 2025-01-15
**修復內容：** 新增 `await auth.authorize()` 確保在實際使用前獲取 access token










