# 🧪 測試執行指南 - 預約 API 寫入測試

## 📋 測試前準備

### ✅ 步驟 1：確認開發伺服器已重新啟動

**重要：** 修復工作表名稱後，必須重新啟動開發伺服器！

**檢查方式：**
- 終端機應顯示：`✓ Ready in X.Xs`
- 應顯示：`- Local: http://localhost:3000`

---

## 🎯 核心任務一：執行測試與提供終端機日誌

### 步驟 1：訪問預約頁面

1. **開啟瀏覽器**
2. **訪問：** `http://localhost:3000/reservation`
3. **確認頁面正常載入**

### 步驟 2：填寫並提交測試預約單

**填寫以下測試資料：**

| 欄位 | 測試值 |
|------|--------|
| 姓名 | `測試用戶_$(date +%Y%m%d_%H%M%S)` 或 `測試用戶_20250115` |
| 電話 | `0912345678` |
| 日期 | 選擇**未來日期**（例如：明天或後天） |
| 時段 | 選擇任一時段（例如：`11:30 - 14:00 午餐`） |
| 人數 | `2` |
| 備註 | `測試預約單_$(timestamp)`（可選） |

**提交方式：**
1. 點擊「提交預約」按鈕
2. **立即查看終端機**（運行 `npm run dev` 的窗口）

### 步驟 3：檢查終端機日誌

#### ✅ 成功情況的日誌範例

如果成功，終端機應顯示類似以下內容：

```
📝 收到預約請求
📋 接收到的資料: {
  "name": "測試用戶_20250115",
  "phone": "0912345678",
  "date": "2025-01-16",
  "time": "11:30-14:00",
  "guests": 2,
  "notes": "測試預約單"
}
🔐 開始 Google 身份驗證...
📋 環境變數讀取檢查:
  GOOGLE_SERVICE_ACCOUNT_EMAIL: places-api-service@localbizfinder-477001.iam.gserviceaccount.com
  GOOGLE_SERVICE_ACCOUNT_KEY:
    長度: 1679 字符
    前 50 字符預覽: -----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0...
    是否包含換行符: 是
    是否包含 \n 字串: 否
📊 初始化 Google Sheets API...
📅 初始化 Google Calendar API...
⏰ 處理日期和時間...
   解析時段: 11:30-14:00 -> 11:30 到 14:00
   開始時間: 2025-01-16T11:30:00
   結束時間: 2025-01-16T14:00:00
   ISO 開始時間: 2025-01-16T03:30:00.000Z
   ISO 結束時間: 2025-01-16T06:00:00.000Z
📅 創建 Google 日曆事件...
   日曆 ID: your-calendar-id@group.calendar.google.com
   活動標題: [Brunch 預約] 測試用戶_20250115 (2人)
✅ 日曆事件創建成功: https://calendar.google.com/calendar/event?eid=...
📊 寫入 Google Sheets...
   試算表 ID: your-spreadsheet-id
   工作表名稱: Reservations_v2_MAIN
   寫入資料: [["測試用戶_20250115","0912345678","2025-01-16","11:30-14:00","2","測試預約單","https://calendar.google.com/calendar/event?eid=...","2025/1/15 下午3:30:00"]]
✅ Google Sheets 寫入成功
✅ 預約成功完成
POST /api/reservation 200 in 4379ms
```

**請完整複製以上日誌內容！**

#### ❌ 失敗情況的日誌範例

如果失敗，終端機會顯示類似以下內容：

```
📝 收到預約請求
📋 接收到的資料: {...}
🔐 開始 Google 身份驗證...
📋 環境變數讀取檢查:
  GOOGLE_SERVICE_ACCOUNT_EMAIL: ❌ 未設定
  GOOGLE_SERVICE_ACCOUNT_KEY: ❌ 未設定
❌ 預約寫入失敗:
錯誤訊息: GOOGLE_SERVICE_ACCOUNT_KEY 環境變數未設定
錯誤堆疊: Error: GOOGLE_SERVICE_ACCOUNT_KEY 環境變數未設定
    at POST (webpack-internal:///(rsc)/./app/api/reservation/route.ts:62:19)
    ...
完整錯誤物件: {
  "message": "GOOGLE_SERVICE_ACCOUNT_KEY 環境變數未設定",
  "stack": "..."
}
環境變數檢查:
  GOOGLE_SHEETS_ID: ❌ 未設定
  GOOGLE_CALENDAR_ID: ❌ 未設定
  GOOGLE_SERVICE_ACCOUNT_EMAIL: ❌ 未設定
  GOOGLE_SERVICE_ACCOUNT_KEY: ❌ 未設定
POST /api/reservation 500 in 4379ms
```

**請完整複製所有錯誤日誌內容！**

### 步驟 4：驗證 Google Sheets（成功時）

1. **開啟 Google Sheets**
2. **找到試算表**（使用 `GOOGLE_SHEETS_ID`）
3. **切換到工作表：** `Reservations_v2_MAIN`
4. **檢查最後一筆資料**，應包含：
   - 姓名：測試用戶_20250115
   - 電話：0912345678
   - 日期：2025-01-16
   - 時段：11:30-14:00
   - 人數：2
   - 備註：測試預約單
   - 日曆連結：https://calendar.google.com/...
   - 時間戳記：2025/1/15 下午3:30:00

5. **截圖證明：** 請截圖顯示新寫入的資料行

---

## 🎯 核心任務二：確認 Google Sheets 權限

### 步驟 1：開啟 Google Sheets

1. 訪問 [Google Sheets](https://sheets.google.com/)
2. 找到您的試算表（使用 `GOOGLE_SHEETS_ID`）

### 步驟 2：檢查服務帳號權限

1. **點擊右上角「共用」按鈕**
2. **在「與使用者和群組共用」區域中查找：**
   - 服務帳號 Email：`places-api-service@localbizfinder-477001.iam.gserviceaccount.com`
3. **確認權限等級：**
   - ✅ **編輯者** - 正確（可以寫入）
   - ⚠️ **檢視者** - 錯誤（無法寫入）
   - ⚠️ **註解者** - 錯誤（無法寫入）
   - ❌ **未找到** - 需要新增

### 步驟 3：設定權限（如果需要）

**如果服務帳號未在共用列表中：**

1. **點擊「共用」按鈕**
2. **在「新增使用者和群組」欄位中輸入：**
   ```
   places-api-service@localbizfinder-477001.iam.gserviceaccount.com
   ```
3. **選擇權限等級：** 「編輯者」
4. **點擊「傳送」或「完成」**

**如果服務帳號權限不是「編輯者」：**

1. **找到服務帳號 Email**
2. **點擊權限下拉選單**
3. **選擇「編輯者」**
4. **確認變更**

### 步驟 4：回報權限狀態

**請回報以下資訊：**

```
✅ 服務帳號已設定為「編輯者」權限
或
❌ 服務帳號未在共用列表中，已新增為「編輯者」
或
⚠️ 服務帳號權限為「檢視者」，已更新為「編輯者」
```

---

## 📝 回報格式

### 成功情況回報

```
【測試結果：成功】

1. 終端機日誌：
[完整複製終端機日誌內容]

2. Google Sheets 截圖：
[附上截圖，顯示新寫入的資料行]

3. 權限確認：
✅ 服務帳號 places-api-service@localbizfinder-477001.iam.gserviceaccount.com 已設定為「編輯者」權限
```

### 失敗情況回報

```
【測試結果：失敗】

1. 終端機錯誤日誌：
[完整複製所有錯誤日誌內容，包括：
- 錯誤訊息
- 錯誤堆疊
- 完整錯誤物件
- 環境變數檢查結果]

2. 權限確認：
[服務帳號權限狀態]

3. 其他觀察：
[任何其他觀察到的問題]
```

---

## 🔍 常見錯誤與解決方法

### 錯誤 1：環境變數未設定

**症狀：** 終端機顯示「❌ 未設定」

**解決方法：**
1. 確認 `.env.local` 檔案存在於 `soloai-website` 目錄
2. 確認環境變數名稱正確（大小寫敏感）
3. 重新啟動開發伺服器

### 錯誤 2：權限不足

**症狀：** 錯誤訊息包含「permission denied」或「insufficient permissions」

**解決方法：**
1. 確認服務帳號有「編輯者」權限
2. 確認服務帳號 Email 正確

### 錯誤 3：工作表不存在

**症狀：** 錯誤訊息包含「sheet not found」或「range not found」

**解決方法：**
1. 確認工作表名稱：`Reservations_v2_MAIN`
2. 確認工作表存在於試算表中

### 錯誤 4：試算表 ID 錯誤

**症狀：** 錯誤訊息包含「spreadsheet not found」

**解決方法：**
1. 確認 `GOOGLE_SHEETS_ID` 正確
2. 從 Google Sheets 網址列取得正確的 ID

---

## ⚠️ 重要提醒

1. **必須重新啟動開發伺服器** - 修復後才能生效
2. **完整複製日誌** - 不要只複製部分內容
3. **截圖證明** - 成功時請提供 Google Sheets 截圖
4. **權限確認** - 必須確認服務帳號權限為「編輯者」

---

**請按照以上步驟執行測試，並提供完整的測試結果！** 🚀










